<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="EMAIL_CONTENT" >
  <resultMap id="EmailContentResult" class="com.lvmama.comm.pet.po.email.EmailContent" >
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Thu Aug 02 16:45:15 CST 2012.
    -->
    <result column="CONTENT_ID" property="contentId"  />
    <result column="SUBJECT" property="subject"  />
    <result column="CONTENT_FILE_ID" property="contentFileId"  />
    <result column="MAIL_HEADER" property="mailHeader"  />
    <result column="FROM_ADDRESS" property="fromAddress"  />
    <result column="FROM_NAME" property="fromName"  />
    <result column="TO_ADDRESS" property="toAddress"  />
    <result column="CC_ADDRESS" property="ccAddress"  />
    <result column="STATUS" property="status"  />
    <result column="CREATE_TIME" property="createTime"  />
    <result column="SEND_TIME" property="sendTime"  />
    <result column="SEND_COUNT" property="sendCount"  />
  </resultMap>
  <select id="selectByPrimaryKey" resultMap="EmailContentResult" parameterClass="com.lvmama.comm.pet.po.email.EmailContent" >
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Thu Aug 02 16:45:15 CST 2012.
    -->
    select CONTENT_ID, SUBJECT, CONTENT_FILE_ID, MAIL_HEADER, FROM_ADDRESS, FROM_NAME, TO_ADDRESS, STATUS,
      CREATE_TIME, SEND_TIME, SEND_COUNT,CC_ADDRESS
    from EMAIL_CONTENT
    where CONTENT_ID = #contentId#
  </select>
  <delete id="deleteByPrimaryKey" parameterClass="com.lvmama.comm.pet.po.email.EmailContent" >
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Thu Aug 02 16:45:15 CST 2012.
    -->
    delete from EMAIL_CONTENT
    where CONTENT_ID = #contentId#
  </delete>
  <insert id="insert" parameterClass="com.lvmama.comm.pet.po.email.EmailContent" >
    <selectKey keyProperty="contentId" resultClass="java.lang.Long">
			SELECT EMAIL_CONTENT_SEQ.NEXTVAL FROM DUAL
	</selectKey>
    insert into EMAIL_CONTENT (CONTENT_ID, SUBJECT, CONTENT_FILE_ID, MAIL_HEADER, FROM_ADDRESS,
      FROM_NAME, TO_ADDRESS,CC_ADDRESS, STATUS, CREATE_TIME, SEND_TIME, SEND_COUNT)
    values (#contentId#, #subject#, #contentFileId#, #mailHeader#,
      #fromAddress#, #fromName#, #toAddress#, #ccAddress#, #status#,
      #createTime#, #sendTime#, #sendCount#)
  </insert>
  <update id="updateByPrimaryKey" parameterClass="com.lvmama.comm.pet.po.email.EmailContent" >
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Thu Aug 02 16:45:15 CST 2012.
    -->
    update EMAIL_CONTENT
    set SUBJECT = #subject#,
      CONTENT_FILE_ID = #contentFileId#,
      MAIL_HEADER = #mailHeader#,
      FROM_ADDRESS = #fromAddress#,
      FROM_NAME = #fromName#,
      TO_ADDRESS = #toAddress#,
      CC_ADDRESS = #ccAddress#,
      STATUS = #status#,
      CREATE_TIME = #createTime#,
      SEND_TIME = #sendTime#,
      SEND_COUNT = #sendCount#
    where CONTENT_ID = #contentId#
  </update>
  <update id="updateByPrimaryKeySelective" parameterClass="com.lvmama.comm.pet.po.email.EmailContent" >
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Thu Aug 02 16:45:15 CST 2012.
    -->
    update EMAIL_CONTENT
    <dynamic prepend="set" >
      <isNotNull prepend="," property="subject" >
        SUBJECT = #subject#
      </isNotNull>
      <isNotNull prepend="," property="contentFileId" >
        CONTENT_FILE_ID = #contentFileId#
      </isNotNull>
      <isNotNull prepend="," property="mailHeader" >
        MAIL_HEADER = #mailHeader#
      </isNotNull>
      <isNotNull prepend="," property="fromAddress" >
        FROM_ADDRESS = #fromAddress#
      </isNotNull>
      <isNotNull prepend="," property="fromName" >
        FROM_NAME = #fromName#
      </isNotNull>
      <isNotNull prepend="," property="toAddress" >
        TO_ADDRESS = #toAddress#
      </isNotNull>
      <isNotNull prepend="," property="ccAddress" >
        CC_ADDRESS = #ccAddress#
      </isNotNull>
      <isNotNull prepend="," property="status" >
        STATUS = #status#
      </isNotNull>
      <isNotNull prepend="," property="createTime" >
        CREATE_TIME = #createTime#
      </isNotNull>
      <isNotNull prepend="," property="sendTime" >
        SEND_TIME = #sendTime#
      </isNotNull>
      <isNotNull prepend="," property="sendCount" >
        SEND_COUNT = #sendCount#
      </isNotNull>
    </dynamic>
    where CONTENT_ID = #contentId#
  </update>
  
  <sql id="dynamicWhere">
  	<dynamic prepend="WHERE">
  		<isNotEmpty prepend="AND" property="contentId">
  			CONTENT_ID=#contentId#
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="complaintId">
  			CONTENT_ID in (
		      	select email_id from nc_complaint_relation ncr where ncr.complaint_id=#complaintId# and email_id is not null)
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="subject">
  			SUBJECT LIKE '$subject$'
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="fromAddress">
  			FROM_ADDRESS LIKE '$fromAddress$'
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="fromName">
  			FROM_NAME LIKE '$fromName$'
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="toAddress">
  			TO_ADDRESS LIKE '$toAddress$'
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="ccAddress">
  			CC_ADDRESS LIKE '$ccAddress$'
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="status">
  			STATUS=#status#
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="createTimeFrom">
  			CREATE_TIME &gt;=#createTimeFrom#
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="createTimeTo">
  			CREATE_TIME &lt;#createTimeFrom#
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="sendTimeFrom">
  			SEND_TIME &gt;=#sendTimeFrom#
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="sendTimeTo">
  			SEND_TIME &lt;#sendTimeTo#
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="sendCountFrom">
  			SEND_COUNT &gt;=#sendCountFrom#
  		</isNotEmpty>
  		<isNotEmpty prepend="AND" property="sendCountTo">
  			SEND_COUNT &lt;#sendCountTo#
  		</isNotEmpty>
  	</dynamic>
  </sql>
   <select id="selectByParamsList" resultMap="EmailContentResult" parameterClass="java.util.Map" >
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Thu Aug 02 16:45:15 CST 2012.
    -->
    select CONTENT_ID, SUBJECT, CONTENT_FILE_ID, MAIL_HEADER, FROM_ADDRESS, FROM_NAME, TO_ADDRESS, CC_ADDRESS, STATUS,
      CREATE_TIME, SEND_TIME, SEND_COUNT
    from EMAIL_CONTENT
    <include refid="dynamicWhere"/>
  </select>
  <select id="selectByParamsCount" resultClass="Long" parameterClass="java.util.Map" >
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Thu Aug 02 16:45:15 CST 2012.
    -->
    select count(CONTENT_ID) from EMAIL_CONTENT
    <include refid="dynamicWhere"/>
  </select>
  <select id="getQueuedEmailList" resultMap="EmailContentResult" parameterClass="java.util.Map">
  	<![CDATA[ SELECT CONTENT_ID, SUBJECT, CONTENT_FILE_ID, MAIL_HEADER, FROM_ADDRESS, FROM_NAME, TO_ADDRESS, CC_ADDRESS, STATUS,
      CREATE_TIME, SEND_TIME, SEND_COUNT FROM EMAIL_CONTENT EC 
      WHERE (EC.SEND_TIME<=#sendTimeTo# OR EC.SEND_TIME IS NULL) AND EC.SEND_COUNT<#sendCountTo# 
      AND EC.STATUS IN('UNSEND','FAIL','SENDING')
  	  ORDER BY EC.CREATE_TIME ]]>
  </select>
</sqlMap>